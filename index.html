<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Techo</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• React Âíå ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. ËºâÂÖ• Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #F7F4EB; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Ë°®ÂñÆËº∏ÂÖ•Ê°ÜËÅöÁÑ¶ÊôÇÁöÑÊ®£Âºè */
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #88C9A1;
            outline-offset: -2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. ÂÖßÂª∫ÂúñÊ®ô ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const MapPin = (props) => <Icon {...props} path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />;
        const Calendar = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const CreditCard = (props) => <Icon {...props} path={<><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></>} />;
        const CheckSquare = (props) => <Icon {...props} path={<><path d="m9 11 3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />;
        const Users = (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const Plus = (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />;
        const Plane = (props) => <Icon {...props} path={<><path d="M2 12h20"/><path d="M13 2 9 12l4 10"/></>} />;
        const Ticket = (props) => <Icon {...props} path={<><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></>} />;
        const Trash2 = (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />;
        const Utensils = (props) => <Icon {...props} path={<><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>} />;
        const ArrowLeft = (props) => <Icon {...props} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />;
        const Settings = (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;
        const Car = (props) => <Icon {...props} path={<><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const Palmtree = (props) => <Icon {...props} path={<><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2c0-1.66 1.57-3 3.5-3S11 6.34 11 8h2Z"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3c0-1.66-1.12-3-2.5-3-.5 0-1 .13-1.5.36"/><path d="M11 22v-8"/><path d="M11 14a5 5 0 0 1 5 5v2"/><path d="M11 14a5 5 0 0 0-5 5v2"/></>} />;
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />;
        const Hotel = (props) => <Icon {...props} path={<><path d="M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Z"/><polyline points="7 2 7 22"/><polyline points="17 2 17 22"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="22" y1="17" y2="17"/><path d="M12 2v20"/></>} />;

        // --- 1. React ÊáâÁî®Á®ãÂºè ---
        const { useState, useEffect } = React;

        // ==============================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Google Script Á∂≤ÂùÄ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ==============================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyydfOtbXRGqFUzzLCaSxaPQ1kflANTMK4V2b4bZtDFWLiNqNcfKSdU8lOuCrby4le/exec"; 
        // ==============================================

        const api = {
            fetch: async (sheet, tripId = null) => {
                if (GOOGLE_SCRIPT_URL.includes("ÊÇ®ÁöÑID")) return [];
                let url = `${GOOGLE_SCRIPT_URL}?action=get&sheet=${sheet}`;
                if (tripId) url += `&tripId=${tripId}`;
                try {
                    const res = await fetch(url);
                    const json = await res.json();
                    return json;
                } catch (e) {
                    console.error("Fetch error", e);
                    return [];
                }
            },
            post: async (action, sheet, data) => {
                if (GOOGLE_SCRIPT_URL.includes("ÊÇ®ÁöÑID")) {
                    alert("Ë´ãÂÖàË®≠ÂÆö Google Script URL");
                    return;
                }
                const payload = JSON.stringify({ action, sheet, data });
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: payload });
            }
        };

        const useSheetData = (sheetName, tripId, refreshTrigger) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const load = async () => {
                    if (sheetName !== 'trips' && !tripId) return;
                    setLoading(true);
                    const items = await api.fetch(sheetName, tripId);
                    if (Array.isArray(items)) {
                        items.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
                        setData(items);
                    }
                    setLoading(false);
                };
                load();
            }, [sheetName, tripId, refreshTrigger]);

            return { data, loading };
        };

        const theme = {
            bg: '#F7F4EB',
            text: '#5D5745',
            primary: '#88C9A1',
            shadow: '4px 4px 0px #E0E5D5',
        };

        // --- UI Components ---
        const Card = ({ children, className = '', onClick }) => (
            <div 
                onClick={onClick}
                className={`bg-white rounded-3xl border-2 border-[#E6E0D0] transition-all relative overflow-hidden ${className}`}
                style={{ boxShadow: onClick ? theme.shadow : 'none', color: theme.text }}
            >
                <div className="p-4">{children}</div>
            </div>
        );

        const Button = ({ children, onClick, loading, className = '', type="button" }) => (
            <button 
                type={type}
                onClick={onClick}
                disabled={loading}
                className={`bg-[#88C9A1] text-white px-4 py-3 w-full rounded-2xl font-bold border-2 border-transparent active:scale-95 transition-all flex items-center justify-center gap-2 shadow-[0_4px_0_rgba(0,0,0,0.1)] disabled:opacity-50 ${className}`}
            >
                {loading ? <RefreshCw className="animate-spin" size={20} /> : children}
            </button>
        );

        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-sm font-bold text-gray-500 mb-1 ml-1">{label}</label>
                <input 
                    {...props}
                    className="w-full bg-white border-2 border-[#E6E0D0] rounded-xl px-4 py-3 font-bold text-[#5D5745] focus:border-[#88C9A1] focus:ring-0 transition-colors"
                />
            </div>
        );

        const Select = ({ label, children, ...props }) => (
            <div className="mb-4">
                <label className="block text-sm font-bold text-gray-500 mb-1 ml-1">{label}</label>
                <select 
                    {...props}
                    className="w-full bg-white border-2 border-[#E6E0D0] rounded-xl px-4 py-3 font-bold text-[#5D5745] focus:border-[#88C9A1] focus:ring-0 transition-colors appearance-none"
                >
                    {children}
                </select>
            </div>
        );

        const AddPageLayout = ({ title, children, onCancel, onSubmit, loading }) => (
            <div className="fixed inset-0 z-50 bg-[#F7F4EB] flex flex-col animate-fade-in">
                <div className="p-6 flex items-center gap-2">
                    <button onClick={onCancel} className="p-2 -ml-2 text-gray-400 hover:text-[#5D5745]">
                        <ArrowLeft size={24} />
                    </button>
                    <h2 className="text-xl font-black text-[#5D5745]">{title}</h2>
                </div>
                <div className="flex-1 overflow-y-auto px-6 pb-24">
                    <form onSubmit={onSubmit}>
                        {children}
                        <div className="mt-8">
                            <Button type="submit" loading={loading}>Á¢∫Ë™çÊñ∞Â¢û</Button>
                        </div>
                    </form>
                </div>
            </div>
        );

        // --- Feature Components ---

        const TripSelection = ({ onSelectTrip, triggerRefresh }) => {
            const { data: trips, loading } = useSheetData('trips', null, triggerRefresh);
            const [isAdding, setIsAdding] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleCreate = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const formData = new FormData(e.target);
                await api.post('add', 'trips', {
                    title: formData.get('title'),
                    startDate: formData.get('startDate'),
                    coverEmoji: ['üáØüáµ', 'üáπüá≠', 'üá∫üá∏', 'üá∞üá∑', 'üá´üá∑'][Math.floor(Math.random() * 5)]
                });
                // Âª∂ÈÅ≤Âà∑Êñ∞‰ª•Á¢∫‰øùË≥áÊñôÂØ´ÂÖ•
                setTimeout(() => {
                    setIsSubmitting(false);
                    setIsAdding(false);
                    window.location.reload();
                }, 1500);
            };

            if (isAdding) {
                return (
                    <AddPageLayout title="Âª∫Á´ãÊñ∞ÊóÖÁ®ã" onCancel={() => setIsAdding(false)} onSubmit={handleCreate} loading={isSubmitting}>
                        <Input name="title" label="ÊóÖÁ®ãÂêçÁ®±" placeholder="‰æãÂ¶Ç: 2024 Êù±‰∫¨Ë∑®Âπ¥" required />
                        <Input name="startDate" label="Âá∫ÁôºÊó•Êúü" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                    </AddPageLayout>
                );
            }

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="flex justify-between items-end px-2">
                        <div>
                            <h1 className="text-3xl font-black text-[#5D5745]">My Trips</h1>
                            <p className="text-gray-500 font-bold">Google Sheets Áâà</p>
                        </div>
                        <Palmtree size={32} className="text-[#88C9A1]" />
                    </div>

                    <div className="space-y-4">
                        {loading ? <div className="text-center py-10 text-gray-400">ËÆÄÂèñ‰∏≠...</div> : 
                        trips.length === 0 ? <div className="text-center py-10 opacity-50 border-2 border-dashed rounded-3xl">Â∞öÁÑ°ÊóÖÁ®ã<br/><span className="text-sm">ÈªûÊìä‰∏ãÊñπÊåâÈàïÂª∫Á´ã</span></div> :
                        trips.map(trip => (
                            <Card key={trip.id} onClick={() => onSelectTrip(trip)} className="active:scale-95 group">
                                <div className="flex gap-4 items-center">
                                    <div className="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-3xl shadow-inner">
                                        {trip.coverEmoji}
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold">{trip.title}</h3>
                                        <div className="flex items-center gap-1 text-gray-400 text-sm mt-1 font-bold">
                                            <Calendar size={14} />
                                            {trip.startDate}
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                    <Button onClick={() => setIsAdding(true)}><Plus /> Âª∫Á´ãÊñ∞ÊóÖÁ®ã</Button>
                </div>
            );
        };

        const ScheduleTab = ({ trip, refreshTrigger, onUpdate }) => {
            const { data: events, loading } = useSheetData('events', trip.id, refreshTrigger);
            const sortedEvents = events ? [...events].sort((a,b) => (a.time || '').localeCompare(b.time || '')) : [];
            const [isAdding, setIsAdding] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleAdd = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const formData = new FormData(e.target);
                await api.post('add', 'events', { 
                    tripId: trip.id, 
                    title: formData.get('title'), 
                    time: formData.get('time'), 
                    location: formData.get('location') || 'Êú™ÂÆöÂú∞Èªû',
                    type: formData.get('type') 
                });
                onUpdate();
                setIsSubmitting(false);
                setIsAdding(false);
            };

            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if(confirm("Âà™Èô§Ê≠§Ë°åÁ®ã?")) {
                    await api.post('delete', 'events', { id });
                    onUpdate();
                }
            };

            if (isAdding) {
                return (
                    <AddPageLayout title="Êñ∞Â¢ûË°åÁ®ã" onCancel={() => setIsAdding(false)} onSubmit={handleAdd} loading={isSubmitting}>
                        <Input name="title" label="Ë°åÁ®ãÂêçÁ®±" placeholder="‰æãÂ¶Ç: Êô¥Á©∫Â°îËßÄÂÖâ" required />
                        <div className="grid grid-cols-2 gap-4">
                            <Input name="time" label="ÊôÇÈñì" type="time" defaultValue="10:00" required />
                            <Select name="type" label="È°ûÂûã">
                                <option value="spot">ÊôØÈªû</option>
                                <option value="food">ÁæéÈ£ü</option>
                                <option value="transport">‰∫§ÈÄö</option>
                            </Select>
                        </div>
                        <Input name="location" label="Âú∞Èªû" placeholder="ÂèØÈÅ∏Â°´" />
                    </AddPageLayout>
                );
            }

            return (
                <div className="space-y-6 pb-24">
                    {loading && <p className="text-center text-gray-400 text-xs animate-pulse">ÂêåÊ≠•‰∏≠...</p>}
                    <div className="relative pl-4 border-l-2 border-dashed border-gray-300 ml-4 space-y-6 min-h-[300px]">
                        {sortedEvents.length === 0 && !loading && <p className="text-gray-400 text-sm pl-4 pt-4">ÈªûÊìä‰∏ãÊñπÊåâÈàïÊñ∞Â¢ûË°åÁ®ã</p>}
                        {sortedEvents.map(event => (
                            <div key={event.id} className="relative pl-6 animate-fade-in">
                                <div className="absolute -left-[25px] top-3 w-4 h-4 rounded-full bg-white border-4 border-[#F2D0A4]"></div>
                                <Card>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                {event.type === 'food' ? <Utensils size={14} className="text-orange-400"/> : 
                                                 event.type === 'transport' ? <Car size={14} className="text-blue-400"/> : 
                                                 <MapPin size={14} className="text-green-400"/>}
                                                <h3 className="font-bold text-lg">{event.title}</h3>
                                            </div>
                                            <div className="flex items-center gap-2 text-sm text-gray-400">
                                                <span className="font-mono bg-gray-100 px-1 rounded text-xs text-gray-600 font-bold">{event.time}</span>
                                                <span className="text-xs">{event.location}</span>
                                            </div>
                                        </div>
                                        <button onClick={(e) => handleDelete(e, event.id)} className="text-gray-200 hover:text-red-400">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                </Card>
                            </div>
                        ))}
                    </div>
                    <Button onClick={() => setIsAdding(true)}><Plus /> Êñ∞Â¢ûË°åÁ®ã</Button>
                </div>
            );
        };

        const BookingsTab = ({ trip, refreshTrigger, onUpdate }) => {
            const { data: bookings, loading } = useSheetData('bookings', trip.id, refreshTrigger);
            const [isAdding, setIsAdding] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleAdd = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const formData = new FormData(e.target);
                await api.post('add', 'bookings', { 
                    tripId: trip.id, 
                    type: formData.get('type'),
                    title: formData.get('title'),
                    detail: formData.get('detail')
                });
                onUpdate();
                setIsSubmitting(false);
                setIsAdding(false);
            };
            
            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if(confirm("Âà™Èô§Ê≠§È†êË®Ç?")) {
                    await api.post('delete', 'bookings', { id });
                    onUpdate();
                }
            };

            const getIcon = (type) => {
                if (type === 'flight') return <Plane size={24} className="text-blue-400" />;
                if (type === 'hotel') return <Hotel size={24} className="text-pink-400" />;
                return <Ticket size={24} className="text-green-400" />;
            }

            if (isAdding) {
                return (
                    <AddPageLayout title="Êñ∞Â¢ûÈ†êË®Ç" onCancel={() => setIsAdding(false)} onSubmit={handleAdd} loading={isSubmitting}>
                        <Select name="type" label="È°ûÂûã">
                            <option value="flight">Ê©üÁ•®</option>
                            <option value="hotel">‰ΩèÂÆø</option>
                            <option value="ticket">Á•®Âà∏/ÂÖ∂‰ªñ</option>
                        </Select>
                        <Input name="title" label="ÂêçÁ®±" placeholder="‰æãÂ¶Ç: ÊòüÂÆáËà™Á©∫ JX800 / ‰∏äÈáéÈ£ØÂ∫ó" required />
                        <Input name="detail" label="Ë©≥Á¥∞Ë≥áË®ä" placeholder="‰æãÂ¶Ç: 10:30 Ëµ∑È£õ / Check-in 15:00" required />
                    </AddPageLayout>
                );
            }

            return (
                <div className="space-y-4 pb-24">
                    {loading && <p className="text-center text-gray-400 text-xs animate-pulse">ÂêåÊ≠•‰∏≠...</p>}
                    {bookings.length === 0 && !loading && <div className="text-center py-10 opacity-50 border-2 border-dashed rounded-3xl">Â∞öÁÑ°È†êË®ÇË≥áÊñô</div>}
                    
                    {bookings.map(item => (
                        <div key={item.id} className="bg-white rounded-3xl overflow-hidden shadow-sm border-2 border-[#E6E0D0] relative">
                            <button onClick={(e) => handleDelete(e, item.id)} className="absolute top-3 right-3 text-gray-200 hover:text-red-400 z-10"><Trash2 size={16}/></button>
                            <div className="bg-[#5D5745] p-3 flex justify-between items-center text-white">
                                <span className="font-bold tracking-widest text-xs uppercase">{item.type}</span>
                                {getIcon(item.type)}
                            </div>
                            <div className="p-4">
                                <h3 className="text-xl font-black text-[#5D5745] mb-1">{item.title}</h3>
                                <p className="text-sm text-gray-400 font-bold">{item.detail}</p>
                            </div>
                             <div className="relative h-4 bg-[#F7F4EB] -mx-1">
                                <div className="absolute top-0 w-full h-[2px] border-t-2 border-dashed border-gray-300"></div>
                            </div>
                            <div className="p-3 bg-white flex justify-between items-center">
                                <span className="text-xs font-mono text-gray-400">BOOKING</span>
                                <div className="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded-full">CONFIRMED</div>
                            </div>
                        </div>
                    ))}
                    <Button onClick={() => setIsAdding(true)}><Plus /> Êñ∞Â¢ûÈ†êË®Ç</Button>
                </div>
            );
        };

        const ExpenseTab = ({ trip, refreshTrigger, onUpdate }) => {
            const { data: expenses } = useSheetData('expenses', trip.id, refreshTrigger);
            const total = expenses ? expenses.reduce((acc, cur) => acc + Number(cur.amount || 0), 0) : 0;
            const [isAdding, setIsAdding] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleAdd = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const formData = new FormData(e.target);
                await api.post('add', 'expenses', { 
                    tripId: trip.id, 
                    amount: formData.get('amount'), 
                    item: formData.get('item') || 'Êú™ÂëΩÂêç', 
                    payer: 'Me' 
                });
                onUpdate();
                setIsSubmitting(false);
                setIsAdding(false);
            };

            if (isAdding) {
                return (
                    <AddPageLayout title="Êñ∞Â¢ûÊîØÂá∫" onCancel={() => setIsAdding(false)} onSubmit={handleAdd} loading={isSubmitting}>
                        <Input name="amount" label="ÈáëÈ°ç (TWD)" type="number" inputMode="numeric" placeholder="0" required autoFocus />
                        <Input name="item" label="È†ÖÁõÆÂêçÁ®±" placeholder="‰æãÂ¶Ç: ÊãâÈ∫µÂçàÈ§ê" required />
                    </AddPageLayout>
                );
            }

            return (
                <div className="space-y-6 pb-24">
                    <Card className="!bg-[#5D5745] !text-white text-center py-6 !border-none">
                        <p className="text-sm opacity-70 font-bold">Á∏ΩÊîØÂá∫ (TWD)</p>
                        <p className="text-4xl font-mono font-black mt-2">${total.toLocaleString()}</p>
                    </Card>
                    <div className="space-y-3">
                        {expenses && expenses.map(e => (
                            <div key={e.id} className="flex justify-between items-center bg-white p-4 rounded-2xl border border-[#E6E0D0] shadow-sm animate-fade-in">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-[#5D5745]">
                                        <CreditCard size={18}/>
                                    </div>
                                    <span className="font-bold">{e.item}</span>
                                </div>
                                <span className="font-mono font-bold text-lg">${Number(e.amount).toLocaleString()}</span>
                            </div>
                        ))}
                    </div>
                    <Button onClick={() => setIsAdding(true)} className="fixed bottom-24 left-6 right-6 w-auto shadow-xl z-10"><Plus /> Ë®ò‰∏ÄÁ≠Ü</Button>
                </div>
            );
        };

        const TodoTab = ({ trip, refreshTrigger, onUpdate }) => {
            const { data: todos } = useSheetData('todos', trip.id, refreshTrigger);
            const [isAdding, setIsAdding] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleAdd = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const formData = new FormData(e.target);
                await api.post('add', 'todos', { tripId: trip.id, text: formData.get('text'), done: false });
                onUpdate();
                setIsSubmitting(false);
                setIsAdding(false);
            };

            const toggle = async (todo) => {
                const newStatus = !(todo.done === true || todo.done === 'TRUE');
                await api.post('update', 'todos', { id: todo.id, updates: { done: newStatus } });
                onUpdate();
            };

            if (isAdding) {
                return (
                    <AddPageLayout title="Êñ∞Â¢ûÂæÖËæ¶" onCancel={() => setIsAdding(false)} onSubmit={handleAdd} loading={isSubmitting}>
                        <Input name="text" label="ÂæÖËæ¶‰∫ãÈ†Ö" placeholder="‰æãÂ¶Ç: Ë≤∑Á∂≤Âç°" required autoFocus />
                    </AddPageLayout>
                );
            }

            return (
                <div className="space-y-3 pb-24">
                    {todos && todos.map(t => {
                        const isDone = t.done === true || t.done === 'TRUE';
                        return (
                            <div key={t.id} onClick={() => toggle(t)} className="flex items-center gap-3 p-4 bg-white rounded-2xl border border-[#E6E0D0] shadow-sm cursor-pointer active:scale-95 transition-all">
                                <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-colors ${isDone ? 'bg-[#88C9A1] border-[#88C9A1]' : 'border-gray-300'}`}>
                                    {isDone && <CheckSquare size={14} className="text-white"/>}
                                </div>
                                <span className={`font-bold flex-1 ${isDone ? 'line-through text-gray-400' : ''}`}>{t.text}</span>
                            </div>
                        );
                    })}
                    <div onClick={() => setIsAdding(true)} className="border-2 border-dashed border-[#E6E0D0] rounded-2xl p-4 flex items-center justify-center gap-2 text-gray-400 cursor-pointer hover:bg-white/50 transition-colors">
                        <Plus size={18} /> Ê∑ªÂä†Êñ∞È†ÖÁõÆ
                    </div>
                </div>
            );
        };

        function App() {
            const [currentTrip, setCurrentTrip] = useState(null);
            const [activeTab, setActiveTab] = useState('schedule');
            const [refreshCount, setRefreshCount] = useState(0);
            const triggerRefresh = () => setRefreshCount(c => c + 1);
            
            const [error, setError] = useState(null);
            if (error) return <div className="p-4 text-red-500">ÁôºÁîüÈåØË™§: {error.message}</div>;

            if (GOOGLE_SCRIPT_URL.includes("ÊÇ®ÁöÑID")) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center bg-[#F7F4EB] text-[#5D5745]">
                        <div className="bg-white p-8 rounded-3xl shadow-xl border-2 border-[#E6E0D0] max-w-sm">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                                <AlertTriangle size={32} />
                            </div>
                            <h1 className="text-xl font-black text-red-500 mb-4">Ë®≠ÂÆöÊú™ÂÆåÊàê</h1>
                            <p className="text-sm text-gray-500 mb-6">Google Script Á∂≤ÂùÄ‰ºº‰πéÊú™Ë®≠ÂÆö„ÄÇ</p>
                        </div>
                    </div>
                );
            }

            const tabs = [
                { id: 'schedule', icon: Calendar, label: 'Ë°åÁ®ã' },
                { id: 'bookings', icon: Ticket, label: 'È†êË®Ç' },
                { id: 'expense', icon: CreditCard, label: 'Ë®òÂ∏≥' },
                { id: 'planning', icon: CheckSquare, label: 'Ê∏ÖÂñÆ' },
            ];

            return (
                <div className="min-h-screen relative flex flex-col overflow-hidden">
                    <div className="fixed inset-0 pointer-events-none opacity-20" style={{ backgroundImage: `radial-gradient(#5D5745 1px, transparent 1px)`, backgroundSize: '24px 24px' }} />

                    <main className="flex-1 p-6 relative z-10 overflow-y-auto hide-scrollbar max-w-md mx-auto w-full">
                        {!currentTrip ? (
                            <TripSelection onSelectTrip={setCurrentTrip} triggerRefresh={refreshCount} />
                        ) : (
                            <div className="animate-fade-in">
                                <div className="flex items-center justify-between mb-6">
                                    <button onClick={() => setCurrentTrip(null)} className="p-2 -ml-2 text-gray-400 hover:text-[#5D5745] flex items-center gap-1 transition-colors">
                                        <ArrowLeft size={20} />
                                        <span className="font-bold text-xs">ËøîÂõû</span>
                                    </button>
                                    <div className="text-center">
                                        <h2 className="font-black text-lg">{currentTrip.title}</h2>
                                        <p className="text-xs text-gray-500 font-bold">{currentTrip.startDate}</p>
                                    </div>
                                    <button className="p-2 -mr-2 text-gray-400"><Settings size={20}/></button>
                                </div>
                                {activeTab === 'schedule' && <ScheduleTab trip={currentTrip} refreshTrigger={refreshCount} onUpdate={triggerRefresh} />}
                                {activeTab === 'expense' && <ExpenseTab trip={currentTrip} refreshTrigger={refreshCount} onUpdate={triggerRefresh} />}
                                {activeTab === 'planning' && <TodoTab trip={currentTrip} refreshTrigger={refreshCount} onUpdate={triggerRefresh} />}
                                {activeTab === 'bookings' && <BookingsTab trip={currentTrip} refreshTrigger={refreshCount} onUpdate={triggerRefresh} />}
                            </div>
                        )}
                    </main>

                    {currentTrip && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-[#E6E0D0] px-6 py-2 pb-6 flex justify-between items-end z-50 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.05)] max-w-md mx-auto">
                            {tabs.map(tab => {
                                const isActive = activeTab === tab.id;
                                const Icon = tab.icon;
                                return (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className="relative flex flex-col items-center gap-1 w-12 transition-all">
                                        <div className={`p-3 rounded-2xl transition-all ${isActive ? 'bg-[#5D5745] text-white -translate-y-4 shadow-lg scale-110' : 'text-gray-300'}`}>
                                            <Icon size={20} strokeWidth={isActive ? 3 : 2} />
                                        </div>
                                        <span className={`text-[10px] font-bold absolute -bottom-1 transition-opacity ${isActive ? 'opacity-100 text-[#5D5745]' : 'opacity-0'}`}>
                                            {tab.label}
                                        </span>
                                    </button>
                                )
                            })}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
